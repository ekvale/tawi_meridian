{% extends 'business_plan/base.html' %}
{% load humanize %}

{% block title %}Financial Dashboard{% endblock %}

{% block business_plan_content %}
<div class="space-y-6">
    {# YTD Summary Cards #}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-lg shadow-md p-6">
            <p class="text-sm font-medium text-gray-600">YTD Revenue</p>
            <p class="text-3xl font-bold text-gray-900 mt-2">${{ ytd_revenue|floatformat:0|intcomma }}</p>
            {% if ytd_revenue_target > 0 %}
            <p class="text-sm text-gray-500 mt-2">
                Target: ${{ ytd_revenue_target|floatformat:0|intcomma }}
                {% if ytd_revenue_target > 0 %}
                ({% widthratio ytd_revenue ytd_revenue_target 100 %}%)
                {% endif %}
            </p>
            {% endif %}
        </div>
        <div class="bg-white rounded-lg shadow-md p-6">
            <p class="text-sm font-medium text-gray-600">YTD Expenses</p>
            <p class="text-3xl font-bold text-gray-900 mt-2">${{ ytd_expenses|floatformat:0|intcomma }}</p>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6">
            <p class="text-sm font-medium text-gray-600">YTD Profit</p>
            <p class="text-3xl font-bold {% if ytd_profit >= 0 %}text-green-600{% else %}text-red-600{% endif %} mt-2">
                ${{ ytd_profit|floatformat:0|intcomma }}
            </p>
        </div>
    </div>

    {# Monthly Charts #}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {# Revenue Chart #}
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">{{ current_year }} Revenue</h2>
            <canvas id="revenueChart" height="300"></canvas>
        </div>

        {# Expenses Chart #}
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">{{ current_year }} Expenses</h2>
            <canvas id="expensesChart" height="300"></canvas>
        </div>
    </div>

    {# Financial Metrics Table #}
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-900">Monthly Financial Metrics</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Target</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actual</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Variance</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for metric in revenue_metrics %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ metric.period_start|date:"M Y" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ metric.get_metric_type_display }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {% if metric.target_value %}${{ metric.target_value|floatformat:0|intcomma }}{% else %}—{% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {% if metric.actual_value %}${{ metric.actual_value|floatformat:0|intcomma }}{% else %}—{% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm {% if metric.variance and metric.variance >= 0 %}text-green-600{% elif metric.variance %}text-red-600{% else %}text-gray-500{% endif %}">
                            {% if metric.variance %}
                                {{ metric.variance|floatformat:0|intcomma }}
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if metric.progress_percentage is not None %}
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-tawi-blue h-2 rounded-full" style="width: {{ metric.progress_percentage }}%"></div>
                            </div>
                            <span class="text-xs text-gray-500">{{ metric.progress_percentage|floatformat:0 }}%</span>
                            {% else %}
                            —
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">No financial metrics yet. <a href="/admin/business_plan/financialmetric/add/" class="text-tawi-blue hover:underline">Add metrics</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
const monthlyData = {{ monthly_data|safe }};

// Revenue Chart
const revenueCtx = document.getElementById('revenueChart').getContext('2d');
new Chart(revenueCtx, {
    type: 'bar',
    data: {
        labels: monthlyData.map(d => d.month),
        datasets: [{
            label: 'Target',
            data: monthlyData.map(d => d.revenue_target),
            backgroundColor: 'rgba(59, 130, 246, 0.5)',
            borderColor: 'rgb(59, 130, 246)',
            borderWidth: 1
        }, {
            label: 'Actual',
            data: monthlyData.map(d => d.revenue_actual),
            backgroundColor: 'rgba(16, 185, 129, 0.5)',
            borderColor: 'rgb(16, 185, 129)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'top' },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toLocaleString();
                    }
                }
            }
        }
    }
});

// Expenses Chart
const expensesCtx = document.getElementById('expensesChart').getContext('2d');
new Chart(expensesCtx, {
    type: 'bar',
    data: {
        labels: monthlyData.map(d => d.month),
        datasets: [{
            label: 'Target',
            data: monthlyData.map(d => d.expense_target),
            backgroundColor: 'rgba(239, 68, 68, 0.5)',
            borderColor: 'rgb(239, 68, 68)',
            borderWidth: 1
        }, {
            label: 'Actual',
            data: monthlyData.map(d => d.expense_actual),
            backgroundColor: 'rgba(251, 146, 60, 0.5)',
            borderColor: 'rgb(251, 146, 60)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'top' },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toLocaleString();
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}
